# CSV è¯æ˜ç³»ç»Ÿæµ‹è¯• Makefile

.PHONY: all test clean build install help

# é»˜è®¤ç›®æ ‡
all: build test

# å¸®åŠ©ä¿¡æ¯
help:
	@echo "CSV Attestation System Test Makefile"
	@echo "===================================="
	@echo ""
	@echo "å¯ç”¨ç›®æ ‡:"
	@echo "  build     - ç¼–è¯‘æ‰€æœ‰ç»„ä»¶"
	@echo "  test      - è¿è¡Œæ‰€æœ‰æµ‹è¯•"
	@echo "  quick     - å¿«é€Ÿæµ‹è¯•"
	@echo "  host-test - ä¸»æœºç¯å¢ƒæµ‹è¯•ï¼ˆç¼–è¯‘å’ŒåŸºç¡€åŠŸèƒ½ï¼‰"
	@echo "  demo      - è¿è¡Œç¤ºä¾‹ç¨‹åº"
	@echo "  clean     - æ¸…ç†ç¼–è¯‘æ–‡ä»¶"
	@echo "  install   - å®‰è£…åˆ°ç³»ç»Ÿ"
	@echo "  env-check - æ£€æŸ¥ç¯å¢ƒ"
	@echo "  help      - æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯"
	@echo ""

# ç¼–è¯‘æ‰€æœ‰ç»„ä»¶
build:
	@echo "ğŸ”¨ ç¼–è¯‘ CSV è¯æ˜ç³»ç»Ÿç»„ä»¶..."
	cd ../csv-attest-sys && cargo build --release
	cd ../csv-attest && cargo build --release
	@echo "âœ… ç¼–è¯‘å®Œæˆ"

# è¿è¡Œæ‰€æœ‰æµ‹è¯•
test:
	@echo "ğŸ§ª è¿è¡Œæ‰€æœ‰æµ‹è¯•..."
	cd ../csv-attest-sys && cargo test
	cd ../csv-attest && cargo test
	@echo "âœ… æµ‹è¯•å®Œæˆ"

# å¿«é€Ÿæµ‹è¯•
quick:
	@echo "âš¡ å¿«é€Ÿæµ‹è¯•..."
	@if [ -f scripts/quick_test.sh ]; then \
		bash scripts/quick_test.sh; \
	else \
		echo "å¿«é€Ÿæµ‹è¯•è„šæœ¬ä¸å­˜åœ¨ï¼Œè¿è¡ŒåŸºç¡€æµ‹è¯•..."; \
		cargo test; \
	fi

# ä¸»æœºç¯å¢ƒæµ‹è¯•
host-test:
	@echo "ğŸ–¥ï¸  ä¸»æœºç¯å¢ƒæµ‹è¯•..."
	@if [ -f scripts/host_test.sh ]; then \
		bash scripts/host_test.sh; \
	else \
		echo "ä¸»æœºæµ‹è¯•è„šæœ¬ä¸å­˜åœ¨ï¼Œè¿è¡ŒåŸºç¡€æµ‹è¯•..."; \
		make build && make test; \
	fi

# è¿è¡Œç¤ºä¾‹ç¨‹åº
demo:
	@echo "ğŸ¯ è¿è¡Œç¤ºä¾‹ç¨‹åº..."
	cd csv-attest && cargo run --example csv_attest_demo

# ç¯å¢ƒæ£€æŸ¥
env-check:
	@echo "ğŸ” æ£€æŸ¥æµ‹è¯•ç¯å¢ƒ..."
	@echo "Rust ç‰ˆæœ¬:"
	@rustc --version || echo "Rust æœªå®‰è£…"
	@echo ""
	@echo "Cargo ç‰ˆæœ¬:"
	@cargo --version || echo "Cargo æœªå®‰è£…"
	@echo ""
	@echo "å†…æ ¸æ¨¡å—çŠ¶æ€:"
	@lsmod | grep csv || echo "CSV å†…æ ¸æ¨¡å—æœªåŠ è½½"
	@echo ""
	@echo "è®¾å¤‡æ–‡ä»¶çŠ¶æ€:"
	@ls -la /dev/csv-guest 2>/dev/null || echo "CSV è®¾å¤‡æ–‡ä»¶ä¸å­˜åœ¨"
	@echo ""
	@echo "ç½‘ç»œè¿æ¥æµ‹è¯•:"
	@curl -s --connect-timeout 5 https://kds.hygon.cn/hrk.cert > /dev/null && echo "KDS æœåŠ¡å¯è®¿é—®" || echo "KDS æœåŠ¡ä¸å¯è®¿é—®"

# æ¸…ç†ç¼–è¯‘æ–‡ä»¶
clean:
	@echo "ğŸ§¹ æ¸…ç†ç¼–è¯‘æ–‡ä»¶..."
	cd csv-attest-sys && cargo clean
	cd csv-attest && cargo clean
	@echo "âœ… æ¸…ç†å®Œæˆ"

# å®‰è£…åˆ°ç³»ç»Ÿ
install:
	@echo "ğŸ“¦ å®‰è£…åˆ°ç³»ç»Ÿ..."
	cd csv-attest-sys && cargo install --path .
	cd csv-attest && cargo install --path .
	@echo "âœ… å®‰è£…å®Œæˆ"

# æ€§èƒ½æµ‹è¯•
benchmark:
	@echo "ğŸ“Š è¿è¡Œæ€§èƒ½æµ‹è¯•..."
	cd csv-attest && cargo run --bin performance_test

# ä»£ç æ£€æŸ¥
check:
	@echo "ğŸ” ä»£ç æ£€æŸ¥..."
	cd csv-attest-sys && cargo check
	cd csv-attest && cargo check
	@echo "âœ… ä»£ç æ£€æŸ¥å®Œæˆ"

# æ ¼å¼åŒ–ä»£ç 
fmt:
	@echo "ğŸ¨ æ ¼å¼åŒ–ä»£ç ..."
	cd csv-attest-sys && cargo fmt
	cd csv-attest && cargo fmt
	@echo "âœ… ä»£ç æ ¼å¼åŒ–å®Œæˆ"

# æ–‡æ¡£ç”Ÿæˆ
doc:
	@echo "ğŸ“š ç”Ÿæˆæ–‡æ¡£..."
	cd csv-attest-sys && cargo doc --no-deps
	cd csv-attest && cargo doc --no-deps
	@echo "âœ… æ–‡æ¡£ç”Ÿæˆå®Œæˆ"

# å‘å¸ƒæ„å»º
release:
	@echo "ğŸš€ å‘å¸ƒæ„å»º..."
	cd csv-attest-sys && cargo build --release
	cd csv-attest && cargo build --release
	@echo "âœ… å‘å¸ƒæ„å»ºå®Œæˆ"

# é›†æˆæµ‹è¯•
integration-test:
	@echo "ğŸ”— é›†æˆæµ‹è¯•..."
	@echo "æµ‹è¯•å†…æ ¸æ¨¡å—..."
	@sudo modprobe csv-guest || echo "æ— æ³•åŠ è½½ CSV å†…æ ¸æ¨¡å—"
	@echo "æµ‹è¯•è®¾å¤‡æ–‡ä»¶..."
	@ls -la /dev/csv-guest || echo "CSV è®¾å¤‡æ–‡ä»¶ä¸å­˜åœ¨"
	@echo "è¿è¡Œç¤ºä¾‹ç¨‹åº..."
	cd csv-attest && cargo run --example csv_attest_demo
	@echo "âœ… é›†æˆæµ‹è¯•å®Œæˆ"
